#!/bin/bash

# AWS configration
export AWS_REGION=<AWS_REGION>
export AWS_ACCESS_KEY_ID=<AWS_ACCESS_KEY_ID>
export AWS_SECRET_ACCESS_KEY=<AWS_SECRET_ACCESS_KEY>
export AWS_B64ENCODED_CREDENTIALS=$(clusterawsadm bootstrap credentials encode-as-profile)

# Cluster specification
CLUSTER_NAME=<CLUSTER_NAME>
export AWS_SSH_KEY_NAME=<AWS_SSH_KEY_NAME>
export AWS_CONTROL_PLANE_MACHINE_TYPE=<AWS_CONTROL_PLANE_MACHINE_TYPE> # t3.micro
export AWS_NODE_MACHINE_TYPE=<AWS_NODE_MACHINE_TYPE> # t3.micro

# create IAM cloudformation
clusterawsadm bootstrap iam create-cloudformation-stack

# create controller 
clusterctl init --infrastructure aws

# create cluster yaml 
clusterctl generate cluster $CLUSTER_NAME \
  --kubernetes-version v1.19.8 \
  --control-plane-machine-count=1 \
  --worker-machine-count=2 \
  > ../clusters/$CLUSTER_NAME.yaml


